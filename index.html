<!DOCTYPE html>
<!-- https://lukelowrey.com/css-variable-theme-switcher/ -->
<html data-theme="light">
<head>
    <meta charset="UTF-8">
    <title>OpenAFPM CAD</title>
    <style>
      @font-face {
        font-family: "Roboto";
        src: url("font/Roboto-Light.ttf");
        font-weight: 300;
      }
      @font-face {
        font-family: "Roboto";
        src: url("font/Roboto-Regular.ttf");
        font-weight: 400;
      }
      @font-face {
        font-family: "Roboto";
        src: url("font/Roboto-Italic.ttf");
        font-weight: 400;
        font-style: italic;
      }
      @font-face {
        font-family: "Roboto";
        src: url("font/Roboto-Medium.ttf");
        font-weight: 500;
      }
      @font-face {
        font-family: "Roboto";
        src: url("font/Roboto-Bold.ttf");
        font-weight: 700;
      }
      :root {
        --spacing: 8px;
        --transition-duration-standard: 250ms;
        --font-family: "Roboto";
        --root-font-size: "Roboto";
        /**
         * Typography based on modular scale factor of 1.2,
         * also known as the Minor Third.
         * @see {@link https://www.modularscale.com/?16&px&1.2}
         */
        --h1: 2.074rem;
        --h2: 1.728rem;
        --h3: 1.44rem;
        --h4: 1.2rem;
        --h5: 1rem;
        --h6: 0.833rem;
        --navigation-rail-width: 80px;
      }
      html[data-theme='light'] {
        --primary-color-main: #43A047; /* Green 600 - https://www.materialui.co/colors */
        --primary-color-dark: #388E3C; /* Green 700 - https://www.materialui.co/colors */
        --error-color-main: #E53935; /* Red 600 - https://www.materialui.co/colors */
        --error-color-dark: #D32F2F; /* Red 700 - https://www.materialui.co/colors */
        --validation-color-main: #D32F2F; /* Red 700 - https://www.materialui.co/colors */
        --background-default: #FFFFFF;
        --background-navigation: #FFFFFF;
        --background-paper: #DCDCDC; /* gainsboro - https://www.materialui.co/htmlcolors */
        --background-disabled: rgba(0, 0, 0, 0.12);
        --background-dropzone: #E8F5E9;
        --text-color: rgba(0, 0, 0, 0.87);
        --text-disabled: rgba(0, 0, 0, 0.38);
        --divider: rgba(0, 0, 0, 0.12);

        /* Generated from material theme builder figma plugin with #43A047 source color */
        /* https://www.figma.com/community/plugin/1034969338659738588/material-theme-builder */
        --md-sys-color-primary: rgb(59 105 57);
        --md-sys-color-surface-tint: rgb(59 105 57);
        --md-sys-color-on-primary: rgb(255 255 255);
        --md-sys-color-primary-container: rgb(188 240 180);
        --md-sys-color-on-primary-container: rgb(0 34 4);
        --md-sys-color-secondary: rgb(82 99 79);
        --md-sys-color-on-secondary: rgb(255 255 255);
        --md-sys-color-secondary-container: rgb(213 232 207);
        --md-sys-color-on-secondary-container: rgb(17 31 15);
        --md-sys-color-tertiary: rgb(56 101 106);
        --md-sys-color-on-tertiary: rgb(255 255 255);
        --md-sys-color-tertiary-container: rgb(188 235 240);
        --md-sys-color-on-tertiary-container: rgb(0 32 35);
        --md-sys-color-error: rgb(186 26 26);
        --md-sys-color-on-error: rgb(255 255 255);
        --md-sys-color-error-container: rgb(255 218 214);
        --md-sys-color-on-error-container: rgb(65 0 2);
        --md-sys-color-background: rgb(247 251 241);
        --md-sys-color-on-background: rgb(25 29 23);
        --md-sys-color-surface: rgb(247 251 241);
        --md-sys-color-on-surface: rgb(25 29 23);
        --md-sys-color-surface-variant: rgb(222 229 216);
        --md-sys-color-on-surface-variant: rgb(66 73 64);
        --md-sys-color-outline: rgb(114 121 111);
        --md-sys-color-outline-variant: rgb(194 201 189);
        --md-sys-color-shadow: rgb(0 0 0);
        --md-sys-color-scrim: rgb(0 0 0);
        --md-sys-color-inverse-surface: rgb(45 50 44);
        --md-sys-color-inverse-on-surface: rgb(239 242 233);
        --md-sys-color-inverse-primary: rgb(161 211 154);
        --md-sys-color-primary-fixed: rgb(188 240 180);
        --md-sys-color-on-primary-fixed: rgb(0 34 4);
        --md-sys-color-primary-fixed-dim: rgb(161 211 154);
        --md-sys-color-on-primary-fixed-variant: rgb(35 80 36);
        --md-sys-color-secondary-fixed: rgb(213 232 207);
        --md-sys-color-on-secondary-fixed: rgb(17 31 15);
        --md-sys-color-secondary-fixed-dim: rgb(186 204 179);
        --md-sys-color-on-secondary-fixed-variant: rgb(59 75 56);
        --md-sys-color-tertiary-fixed: rgb(188 235 240);
        --md-sys-color-on-tertiary-fixed: rgb(0 32 35);
        --md-sys-color-tertiary-fixed-dim: rgb(160 207 212);
        --md-sys-color-on-tertiary-fixed-variant: rgb(31 77 82);
        --md-sys-color-surface-dim: rgb(216 219 210);
        --md-sys-color-surface-bright: rgb(247 251 241);
        --md-sys-color-surface-container-lowest: rgb(255 255 255);
        --md-sys-color-surface-container-low: rgb(241 245 236);
        --md-sys-color-surface-container: rgb(236 239 230);
        --md-sys-color-surface-container-high: rgb(230 233 224);
        --md-sys-color-surface-container-highest: rgb(224 228 219);
      }
      html[data-theme='dark'] {
        --primary-color-main: #A5D6A7; /* Green 200 - https://www.materialui.co/colors */
        --primary-color-dark: #81C784; /* Green 300 - https://www.materialui.co/colors */
        --error-color-main: #E53935; /* Red 600 - https://www.materialui.co/colors */
        --error-color-dark: #D32F2F; /* Red 700 - https://www.materialui.co/colors */
        --validation-color-main: #FF5252; /* Red A200 - https://www.materialui.co/colors */
        --background-default: #212121;
        --background-navigation: #303030;
        --background-paper: #424242;
        --background-disabled: rgba(255, 255, 255, 0.12);
        --background-dropzone: #111;
        --text-color: #FFFFFF;
        --text-disabled: rgba(255, 255, 255, 0.5);
        --divider: rgba(255, 255, 255, 0.12);

        /* Generated from material theme builder figma plugin with #43A047 source color */
        /* https://www.figma.com/community/plugin/1034969338659738588/material-theme-builder */
        --md-sys-color-primary: rgb(161 211 154);
        --md-sys-color-surface-tint: rgb(161 211 154);
        --md-sys-color-on-primary: rgb(10 57 15);
        --md-sys-color-primary-container: rgb(35 80 36);
        --md-sys-color-on-primary-container: rgb(188 240 180);
        --md-sys-color-secondary: rgb(186 204 179);
        --md-sys-color-on-secondary: rgb(37 52 35);
        --md-sys-color-secondary-container: rgb(59 75 56);
        --md-sys-color-on-secondary-container: rgb(213 232 207);
        --md-sys-color-tertiary: rgb(160 207 212);
        --md-sys-color-on-tertiary: rgb(0 54 59);
        --md-sys-color-tertiary-container: rgb(31 77 82);
        --md-sys-color-on-tertiary-container: rgb(188 235 240);
        --md-sys-color-error: rgb(255 180 171);
        --md-sys-color-on-error: rgb(105 0 5);
        --md-sys-color-error-container: rgb(147 0 10);
        --md-sys-color-on-error-container: rgb(255 218 214);
        --md-sys-color-background: rgb(16 20 15);
        --md-sys-color-on-background: rgb(224 228 219);
        --md-sys-color-surface: rgb(16 20 15);
        --md-sys-color-on-surface: rgb(224 228 219);
        --md-sys-color-surface-variant: rgb(66 73 64);
        --md-sys-color-on-surface-variant: rgb(194 201 189);
        --md-sys-color-outline: rgb(140 147 136);
        --md-sys-color-outline-variant: rgb(66 73 64);
        --md-sys-color-shadow: rgb(0 0 0);
        --md-sys-color-scrim: rgb(0 0 0);
        --md-sys-color-inverse-surface: rgb(224 228 219);
        --md-sys-color-inverse-on-surface: rgb(45 50 44);
        --md-sys-color-inverse-primary: rgb(59 105 57);
        --md-sys-color-primary-fixed: rgb(188 240 180);
        --md-sys-color-on-primary-fixed: rgb(0 34 4);
        --md-sys-color-primary-fixed-dim: rgb(161 211 154);
        --md-sys-color-on-primary-fixed-variant: rgb(35 80 36);
        --md-sys-color-secondary-fixed: rgb(213 232 207);
        --md-sys-color-on-secondary-fixed: rgb(17 31 15);
        --md-sys-color-secondary-fixed-dim: rgb(186 204 179);
        --md-sys-color-on-secondary-fixed-variant: rgb(59 75 56);
        --md-sys-color-tertiary-fixed: rgb(188 235 240);
        --md-sys-color-on-tertiary-fixed: rgb(0 32 35);
        --md-sys-color-tertiary-fixed-dim: rgb(160 207 212);
        --md-sys-color-on-tertiary-fixed-variant: rgb(31 77 82);
        --md-sys-color-surface-dim: rgb(16 20 15);
        --md-sys-color-surface-bright: rgb(54 58 52);
        --md-sys-color-surface-container-lowest: rgb(11 15 10);
        --md-sys-color-surface-container-low: rgb(25 29 23);
        --md-sys-color-surface-container: rgb(29 33 27);
        --md-sys-color-surface-container-high: rgb(39 43 37);
        --md-sys-color-surface-container-highest: rgb(50 54 48);
      }
      html {
        font-size: var(--root-font-size);
        overflow-y: scroll;
      }
      body {
        color: var(--text-color);
        background: var(--background-default);
        transition: var(--transition-duration-standard) ease-in-out;
        margin: 0;
        font-family: var(--font-family);
        display: grid;
        grid-template-rows: min-content 1fr;
      }
      html, body {
        height: 100%;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--primary-color-main);
        color: var(--background-default);
        font-size: 1rem;
        font-weight: bold;
        padding: calc(var(--spacing) * 2);
        position: relative;
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5);
        transition: var(--transition-duration-standard) ease-in-out;
      }
      .container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
      #loading-spinner {
        display: inline-block;
        width: 35px;
        height: 35px;
        border: 3px solid var(--primary-color-main);
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      @-webkit-keyframes spin {
        to { transform: rotate(360deg); }
      }
      .dropzone {
        background: var(--background-dropzone);
      }
      @media print {
        header {
          display: none;
        }
      }
    </style>
</head>
<body>
  <header>
    OpenAFPM CAD
    <x-theme-toggle></x-theme-toggle>
  </header>
  <x-app>
    <div id="visualization-root" style="width: 100%; height: 100%">
      <x-empty-state>
        <div class="container">
          <div id="loading-spinner"></div>
          <p>Loading</p>
        </div>
      </x-empty-state>
    </div>
  </x-app>
  <script type="importmap">
    {
      "imports": {
        "lit": "./node_modules/lit/index.js",
        "lit/": "./node_modules/lit/",
        "lit-html": "./node_modules/lit-html/lit-html.js",
        "lit-html/": "./node_modules/lit-html/",
        "lit-element/": "./node_modules/lit-element/",
        "@lit/reactive-element": "./node_modules/@lit/reactive-element/reactive-element.js",
        "@lit/reactive-element/": "./node_modules/@lit/reactive-element/",
        "@material/web/": "./node_modules/@material/web/",
        "tslib": "./node_modules/tslib/tslib.es6.mjs",
        "openafpm-cad-visualization": "./node_modules/openafpm-cad-visualization/public/openafpm-cad-visualization.js"
      }
    }
  </script>
  <script type="module">
    import {styles as typescaleStyles} from "@material/web/typography/md-typescale-styles.js";

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script> 
  <script type="module" src="./frontend/themeToggle.js"></script>
  <script type="module" src="./frontend/app.js"></script>
  <script>
    // Setup theme toggle.
    const themeToggle = document.querySelector("x-theme-toggle");
    const visualizationRoot = document.getElementById("visualization-root");
    const setTheme = theme => {
      themeToggle.setAttribute("theme", theme);
      document.documentElement.setAttribute("data-theme", theme);
      visualizationRoot.setAttribute("data-theme", theme);
    };
    const preferredTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    const presetTheme = localStorage.getItem("theme") || preferredTheme;
    if (presetTheme) setTheme(presetTheme);
    themeToggle.addEventListener("click", () => {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const targetTheme = currentTheme === "light" ? "dark" : "light";
      setTheme(targetTheme);
      localStorage.setItem("theme", targetTheme);
    });

    // Setup app.
    window.addEventListener("load", handleLoad);
    function handleLoad() {
      document.getElementById("loading-spinner").remove();
      const openAfpmCadVisualizationPromise = import(
        "./node_modules/openafpm-cad-visualization/public/openafpm-cad-visualization.js"
      );
      const enumsPromise = import("./frontend/enums.js");
      const groupParametersPromise = import("./frontend/groupParameters.js");
      Promise.all([openAfpmCadVisualizationPromise, enumsPromise, groupParametersPromise])
        .then(setup);
    }
    function setup([{default: OpenAfpmCadVisualization}, enums, {default: groupParameters}]) {
      const { Tab, Preset, Assembly } = enums;
      const app = document.querySelector("x-app");

      const buildRequestBody = (form, parameters) => JSON.stringify(groupParameters(form, parameters));

      // Import SSE utilities
      import("./frontend/sseUtils.js").then(({SSEManager}) => {
        const sseManager = new SSEManager();

      const initialState = {
        preset: Preset.T_SHAPE,
        assembly: Assembly.WIND_TURBINE,
        tab: Tab.INPUTS,
        parametersByPreset: null,
        parametersSchemaByPreset: null, 
        form: null,
        loading: false,
        errorMessage: '',
        visualizeLoading: false,
        visualizeErrorMessage: '',
        archiveLoading: false,
        archiveErrorMessage: '',
        cncOverviewSvgLoading: false,
        cncOverviewSvgErrorMessage: '',
        cncOverviewSvg: '',
        cncOverviewSvgProgress: 0,
        cncOverviewSvgProgressMessage: '',
        dxfArchiveLoading: false,
        dxfArchiveErrorMessage: '',
        dimensionTablesLoading: false,
        dimensionTablesErrorMessage: '',
        dimensionTables: null,
        dimensionTablesProgress: 0,
        dimensionTablesProgressMessage: '',
        visualizeProgress: 0,
        visualizeProgressMessage: '',
        shapeBounds: {
          h_shape_lower_bound: 0,
          star_shape_lower_bound: 0
        }
      };
      Object.assign(app, initialState);
      const setState = (nextState) => {
        Object.assign(app, nextState);
      };

      function fetchJson(...args) {
        return fetch(...args)
          .then(response => response.json())
          .then(response => {
            if (response.error) {
              throw new Error(response.error);
            }
            return response;
          });
      }

      const defaultParametersPromise = fetchJson('/api/defaultparameters');
      const parametersSchemaPromise = fetchJson('/api/parametersschema');

      const promise = Promise.all([defaultParametersPromise, parametersSchemaPromise]);

      function setForm() {
        if (!app.parametersByPreset) return;
        const parameters = flatten(app.parametersByPreset[app.preset]);
        const form = mapValues(parameters, value => ({value, validationMessage: ''}));
        setState({ form });
      }
      promise.then(([parametersByPreset, parametersSchemaByPresetResponse]) => {
        const parameters = flatten(parametersByPreset[initialState.preset]);
        const form = mapValues(parameters, value => ({value, validationMessage: ''}));
        const {bounds, ...parametersSchemaByPreset} = parametersSchemaByPresetResponse;
        setState({
          parametersByPreset,
          parametersSchemaByPreset,
          shapeBounds: bounds
        });
        setForm();
      })
      setPromiseToState(promise, 'loading', 'errorMessage');

      function setPromiseToState(promise, loadingProperty, errorMessageProperty) {
        setState({ [loadingProperty]: true });
        promise.then(() => {
          setState({ [loadingProperty]: false });
        })
        .catch(error => {
          if (error.name !== 'AbortError') {
            setState({
              [errorMessageProperty]: error.message,
              [loadingProperty]: false
            });
          }
        });
      }

      app.addEventListener('close-error', () => {
        setState({ errorMessage: '' });
      });

      app.addEventListener('select-preset', (event) => {
        const { selectedPreset } = event.detail;
        setState({ preset: selectedPreset });
        setForm();
      });

      app.addEventListener('input-change', event => {
        const { name, value, validationMessage, preset } = event.detail;
        setState({
          form: {
            ...app.form,
            [name]: {
              value,
              validationMessage
            }
          }
        });
        // Set the User (excluding WindTurbineShape) and Furling parameters
        // to default values based on "Wind Turbine Shape" selection.
        if (name === "WindTurbineShape") {
          const parameters = app.parametersByPreset[preset];
          const userParameters = {...parameters.user};
          delete userParameters['WindTurbineShape'];
          const furlingAndUserParameters = mapValues({
            ...parameters.furling,
            ...userParameters
          }, value => ({value, validationMessage: ''}));
          setState({
            form: {
              ...app.form,
              ...furlingAndUserParameters
            }
          });
        }
      });

      function calculateWidth() {
        // Get the width of document (without the scrollbar) minus navigation rail width.
        const navigationRailWidth = parseInt(getComputedStyle(document.documentElement)
          .getPropertyValue('--navigation-rail-width'));
        return document.documentElement.clientWidth - navigationRailWidth;
      }
      function calculateHeight() {
        const headerHeight = document.querySelector('header').offsetHeight;
        const tabsHeight = app.renderRoot.querySelector('md-tabs').offsetHeight;
        const offsetHeight = headerHeight + tabsHeight;
        return window.innerHeight - offsetHeight;
      }

      let cleanUp = null;
      let previousBody = null;
      const openAfpmCadVisualization = new OpenAfpmCadVisualization({
        rootDomElement: visualizationRoot,
        width: calculateWidth(),
        height: calculateHeight()
      });
      const handleResize = () => {
        if (app.tab === Tab.VISUALIZE) {
          const width = calculateWidth();
          const height = calculateHeight();
          visualizationRoot.style.height = height + 'px';
          openAfpmCadVisualization.resize(width, height);
        }
      };
      window.addEventListener('resize', handleResize, false);
      let previousAssembly = app.assembly; // Initialize to current assembly
      
      function handleVisualize() {
        if (cleanUp) cleanUp();
        
        const body = buildRequestBody(app.form, app.parametersByPreset[app.preset]);
        const parameters = groupParameters(app.form, app.parametersByPreset[app.preset]);
        const assemblyChanged = app.assembly !== previousAssembly;
        const parametersChanged = previousBody !== body;
        
        console.log('handleVisualize called:');
        console.log(`[TIMESTAMP] ${Date.now()} - handleVisualize called`);
        console.log('  Current assembly:', app.assembly);
        console.log('  Previous assembly:', previousAssembly);
        console.log('  Assembly changed:', assemblyChanged);
        console.log('  Parameters changed:', parametersChanged);
        
        if (parametersChanged) {
          console.log(`[TIMESTAMP] ${Date.now()} - Parameters changed - closing all connections`);
          // Parameters changed - close ALL event sources and start all 3 new ones
          sseManager.closeAllEventSources();
          
          console.log(`[TIMESTAMP] ${Date.now()} - Starting new SSE connections after parameter change...`);
          // Start all 3 SSE connections (backend handles blocking wait for cancellation)
          startVisualizationSSE(app.assembly, parameters);
          startCNCOverviewSSE(parameters);
          startDimensionTablesSSE(parameters);
          
        } else if (assemblyChanged) {
          console.log(`[TIMESTAMP] ${Date.now()} - Assembly changed only - closing visualize connection`);
          // Only assembly changed - close only visualize
          sseManager.closeEventSource('visualize');
          
          // Start only visualization SSE
          startVisualizationSSE(app.assembly, parameters);
        } else {
          console.log(`[TIMESTAMP] ${Date.now()} - No changes detected`);
        }
        
        previousBody = body;
        previousAssembly = app.assembly;
        console.log('Updated previousAssembly to:', previousAssembly);
      }

      let visualizationInitialized = false;
      
      function startVisualizationSSE(assembly, parameters) {
        setState({ 
          visualizeLoading: true, 
          visualizeErrorMessage: '',
          visualizeProgress: 0,
          visualizeProgressMessage: 'Starting...'
        });
        
        // Only call visualize() on first initialization
        if (!visualizationInitialized) {
          visualizationRoot.innerHTML = '';
          
          const loadObjText = () => new Promise(() => {}); // Never resolves, we'll handle completion via SSE
          const furlTransformPromise = Promise.resolve(null);
          
          openAfpmCadVisualization.visualize(loadObjText, assembly, furlTransformPromise);
          handleResize();
          visualizationInitialized = true;
        } else {
          // For assembly switches, just update progress to show we're loading the new assembly
          if (app.visualizeProgress > 0 && app.visualizeProgressMessage) {
            openAfpmCadVisualization.setProgress(app.visualizeProgressMessage, app.visualizeProgress);
          }
        }
        
        sseManager.startVisualizationSSE(assembly, parameters, {
          onProgress: (message, progress) => {
            console.log(`[TIMESTAMP] ${Date.now()} - Visualize progress: ${progress}% - ${message}`);
            setState({
              visualizeProgress: progress,
              visualizeProgressMessage: message
            });
            
            // Pass progress to visualization component
            openAfpmCadVisualization.setProgress(message, progress);
          },
          onComplete: (result) => {
            console.log(`[TIMESTAMP] ${Date.now()} - Visualize completed:`, result);
            setState({ 
              visualizeLoading: false,
              visualizeProgress: 100,
              visualizeProgressMessage: 'Complete'
            });
            
            // Replace the loading with actual content
            visualizationRoot.innerHTML = '';
            const loadObjText = () => Promise.resolve(result.objText);
            const furlTransformPromise = Promise.resolve(result.furlTransform);
            
            openAfpmCadVisualization.visualize(loadObjText, assembly, furlTransformPromise);
            handleResize();
            
            const handleMouseMove = (event) => openAfpmCadVisualization.handleMouseMove(event);
            window.addEventListener('mousemove', handleMouseMove, false);
            
            cleanUp = () => {
              window.removeEventListener('mousemove', handleMouseMove);
            };
          },
          onError: (error) => {
            console.log(`[TIMESTAMP] ${Date.now()} - Visualize SSE error:`, error);
            setState({ 
              visualizeLoading: false, 
              visualizeErrorMessage: error,
              visualizeProgress: 0,
              visualizeProgressMessage: ''
            });
          }
        });
      }

      function startCNCOverviewSSE(parameters) {
        setState({ 
          cncOverviewSvgLoading: true,
          cncOverviewSvgErrorMessage: '',
          cncOverviewSvg: '',
          cncOverviewSvgProgress: 0,
          cncOverviewSvgProgressMessage: 'Starting...'
        });
        
        sseManager.startCNCOverviewSSE(parameters, {
          onProgress: (message, progress) => {
            setState({
              cncOverviewSvgProgress: progress,
              cncOverviewSvgProgressMessage: message
            });
          },
          onComplete: (result) => {
            setState({ 
              cncOverviewSvgLoading: false,
              cncOverviewSvg: result.svg,
              cncOverviewSvgProgress: 100,
              cncOverviewSvgProgressMessage: 'Complete'
            });
          },
          onError: (error) => {
            console.log('CNC Overview SSE error:', error);
            setState({ 
              cncOverviewSvgLoading: false,
              cncOverviewSvgErrorMessage: error,
              cncOverviewSvgProgress: 0,
              cncOverviewSvgProgressMessage: ''
            });
          }
        });
      }

      function startDimensionTablesSSE(parameters) {
        setState({ 
          dimensionTablesLoading: true,
          dimensionTablesErrorMessage: '',
          dimensionTables: null,
          dimensionTablesProgress: 0,
          dimensionTablesProgressMessage: 'Starting...'
        });
        
        sseManager.startDimensionTablesSSE(parameters, {
          onProgress: (message, progress) => {
            setState({
              dimensionTablesProgress: progress,
              dimensionTablesProgressMessage: message
            });
          },
          onComplete: (result) => {
            setState({ 
              dimensionTablesLoading: false,
              dimensionTables: result.tables,
              dimensionTablesProgress: 100,
              dimensionTablesProgressMessage: 'Complete'
            });
          },
          onError: (error) => {
            console.log('Dimension Tables SSE error:', error);
            setState({ 
              dimensionTablesLoading: false,
              dimensionTablesErrorMessage: error,
              dimensionTablesProgress: 0,
              dimensionTablesProgressMessage: ''
            });
          }
        });
      }

      const debouncedVisualizeHandler = debounce(handleVisualize, 200);
      app.addEventListener('visualize', debouncedVisualizeHandler);
      app.addEventListener('select-assembly', (event) => {
        const { selectedAssembly } = event.detail;
        if (app.assembly !== selectedAssembly) {
          setState({ assembly: selectedAssembly });
          // Always trigger visualization when assembly changes
          debouncedVisualizeHandler();
        }
      });
      app.addEventListener('select-tab', (event) => {
        const { selectedTab } = event.detail;
        setState({ tab: selectedTab });
        // resize as a macro-task to ensure DAT GUI
        // is visible before setting its top position.
        setTimeout(handleResize);
      });

      /**
       * Import
       * --------------------------------------------------------------------------------------------------------------*/
      const handleDragOver = event => {
        event.preventDefault();
        if (!document.body.classList.contains('dropzone')) {
          document.body.classList.add('dropzone');
        }
      };
      const handleRemoveDropzoneClass = event => {
        if (document.body.classList.contains('dropzone')) {
          document.body.classList.remove('dropzone');
        }
      };

      const handleFileUpload = file => {
        const filePath = window.electronAPI.webUtils.getPathForFile(file);
        if (file.type === 'application/json') {
          const reader = new FileReader();
          reader.onload = (loadEvent) =>  {
            try {
              // TODO: We should validate this user input instead of trusting it.
              const {preset, ...parametersByGroup} = JSON.parse(loadEvent.target.result);
              const parameters = flatten(parametersByGroup);
              const form = mapValues(parameters, value => ({value, validationMessage: ''}));
              setState({ form });
            } catch (error) {
              console.error(error);
            }
          };
          reader.readAsText(file); 
        } else if (file.name.endsWith('.mat')) {
          const loadmatPromise = fetchJson('/api/loadmat', {
            body: JSON.stringify({path: filePath}),
            headers: {
              'Content-Type': 'application/json'
            },
            method: 'POST',
          });
          loadmatPromise.then(({preset, ...parametersByGroup}) => {
            const parameters = flatten(parametersByGroup);
            const form = mapValues(parameters, value => ({value, validationMessage: ''}));
            setState({ form: {...app.form, ...form} });
            if (preset) setState({ preset });
          });
          loadmatPromise.catch(console.error);
        } else {
          console.warn(`Type of '${file.name}' must be 'application/json' instead of '${file.type}' or name must end with '.mat' extension.`);
        }
      };
      const handleDrop = event => {
        event.preventDefault();
        handleRemoveDropzoneClass(event);
        const firstFile = event.dataTransfer.items?.[0];
        handleFileUpload(firstFile);
      }
      document.body.addEventListener('dragover', handleDragOver);
      document.body.addEventListener('dragleave', handleRemoveDropzoneClass);
      document.body.addEventListener('drop', handleDrop);

      app.addEventListener('file-upload', (event) => {
        handleFileUpload(event.detail.file);
      });
      /** ------------------------------------------------------------------------------------------------------------ */

      function createArchiveDownloadHandler(requestPath, archiveName, loadingProperty, errorMessageProperty) {
        return () => {
          if (!app.form || app[loadingProperty]) return;
          setState({ [loadingProperty]: true, [errorMessageProperty]: '' });
          fetch(requestPath, {
            body: buildRequestBody(app.form, app.parametersByPreset[app.preset]),
            headers: {
              'Content-Type': 'application/json'
            },
            method: 'POST'
          })
          .then(response => {
            if (!response.ok) {
              return response.json();
            }
            return response;
          })
          .then(response => {
            if (response.error) {
              throw new Error(response.error);
            }
            return response;
          })
          .then(response => response.blob())
          .then(blob => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = archiveName;
            link.click();
          })
          .catch(error => {
            if (error.name !== 'AbortError') {
              setState({ [errorMessageProperty]: error.message });
            }
          })
          .finally(() => {
            setState({ [loadingProperty]: false });
          });
        };
      }
      const handleDownloadArchive = createArchiveDownloadHandler(
        '/api/archive', 'WindTurbine.zip', 'archiveLoading', 'archiveErrorMessage'
      );
      app.addEventListener('download-archive', handleDownloadArchive);

      const handleDownloadDxfArchive = createArchiveDownloadHandler(
        '/api/dxfarchive', 'WindTurbineDXF.zip', 'dxfArchiveLoading', 'dxfArchiveErrorMessage'
      );
      app.addEventListener('download-dxf-archive', handleDownloadDxfArchive);
      
      }); // Close SSE import
    }

    function flatten(object) {
      return Object.entries(object)
        .reduce((acc, entry) => {
          const [key, value] = entry;
          return typeof value === 'object' ? {...acc, ...value} : {...acc, [key]: value}
        }, {});
    }

    function mapEntries(obj, entryMapper) {
      return Object.fromEntries(Object.entries(obj).map(entryMapper));
    }

    function mapValues(obj, valueMapper) {
      return mapEntries(obj, ([key, value]) => (
        [key, valueMapper(value)]
      ));
    }

    function debounce(callback, wait) {
      let timeoutId = null;
      return (...args) => {
        window.clearTimeout(timeoutId);
        timeoutId = window.setTimeout(() => {
          callback.apply(null, args);
        }, wait);
      };
    }

  </script>
</body>
</html>
