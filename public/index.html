<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OpenAFPM CAD Visualization</title>
    <style>
        * {
            box-sizing: border-box;
        }
        :root {
            --spacing: 8px;
            --main-color: #43A047; /* Green 600 from https://www.materialui.co/colors */
            --main-color-shade: #388E3C; /* Green 700 from https://www.materialui.co/colors */
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            background: white;
            margin: 0;
            font-family: sans-serif;
            font-size: 16px;
        }
        header {
            display: flex;
            align-items: center;
            margin-bottom: calc(var(--spacing) * 2);
        }
        .logo {
            fill: var(--main-color);
        }
        .container {
            max-width: 70%;
            margin: calc(var(--spacing) * 4) auto;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing) * 2);
        }
        fieldset {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing) * 2);
            margin: 0;
            padding: 0px 0px calc(var(--spacing) * 2) 0px;
            border-top: none;
            border-right: none;
            border-left: none;
            border-bottom: 1px solid gray;
        }
        legend {
            font-size: 1.728rem; /* h2 */
            padding: 0;
            line-height: 1.25;
            margin-bottom: calc(var(--spacing) * 2);
        }
        section {
            display: flex;
            gap: calc(var(--spacing) * 2);
        }
        label {
            flex: 1;
            font-weight: bold;
        }
        input {
            width: 100%;
            margin-top: calc(var(--spacing) * 1);
        }
        select {
            margin-left: calc(var(--spacing) * 1);
            border: 1px solid var(--main-color);
            background-color: white;
            border-radius: 4px;
        }
        input, select {
            padding: 8px;
        }
        button[type="submit"] {
            padding: calc(var(--spacing) * 3);
            text-transform: uppercase;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.30);
        }
        /**
         * Typography based on modular scale factor of 1.2,
         * also known as the Minor Third.
         * @see {@link https://www.modularscale.com/?16&px&1.2}
         */
        h1 {
            font-size: 2.074rem;
        }
        h2 {
            font-size: 1.728rem;
        }
        h3 {
            font-size: 1.44rem;
        }
        h4 {
            font-size: 1.2rem;
        }
        h5 {
            font-size: 1rem;
        }
        h6 {
            font-size: 0.833rem;
        }
        h1, h2, h3, h4, h5, h6 {
            line-height: 1.25;
            margin: 0;
        }
        nav {
            display: flex;
            box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.3);
        }
        nav > button {
            flex: 1;
            border: none;
            background: white;
            padding: calc(var(--spacing) * 3);
            text-transform: uppercase;
            cursor: pointer;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.67);
        }
        .active {
            border-bottom: 3px solid var(--main-color);
            color: var(--main-color);
        }
        .tabcontent {
            transition: opacity 250ms ease-in-out;
        }
        #error-banner {
            display: flex;
            align-items: center;
            background-color: #e53935;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
            color: white;
            border-radius: 4px;
            padding: 16px;
            justify-content: space-between;
            transition: opacity 250ms ease-in-out;
        }
        #error-message {
            margin: 0 0 0 8px;
        }
        .error-icon {
            min-width: 24px;
        }
        .empty-state {
            text-align: center;
            padding-top: 25vh;
        }
        .primary-button {
            background-color: var(--main-color);
            color: white;
            transition: 250ms ease-in-out;
            border: none;
        }
        .primary-button:hover {
            background-color: var(--main-color-shade);
        }
        .primary-button:disabled {
            background-color: #e0e0e0;
            color: #a6a6a6;
            box-shadow: none;
            cursor: default;
        }
        #download-button {
            position: fixed;
            bottom: calc(var(--spacing) * 2);
            right: calc(var(--spacing) * 2);
            display: block;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            padding: 16px;
            box-shadow: 0px 3px 5px -1px rgb(0 0 0 / 20%),
                        0px 6px 10px 0px rgb(0 0 0 / 14%),
                        0px 1px 18px 0px rgb(0 0 0 / 12%);
        }
        .download-icon {
            fill: currentColor;
        }
    </style>
</head>
<body>
    <nav>
        <button class="active" onclick="selectTab(event)">
            Inputs
        </button>
        <button onclick="selectTab(event)">
            Visualize
        </button>
    </nav>
    <div class="container tabcontent">
        <header>
            <svg class="logo" alt="Wind Turbine" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="2.488rem" fill="#2196F3" version="1.1" x="0px" y="0px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><g><path d="M317.027,177.958c-32.982,0-62.777,3.344-84.151,8.718c-6.516-10.781-18.077-18.155-31.405-18.905   c-5.828-21.437-18.077-49.779-35.092-79.247c-32.53-56.31-70.122-95.496-83.996-87.466c-13.874,8,1.219,60.154,33.749,116.465   c16.546,28.687,34.42,52.904,49.81,68.716c-3.75,6.031-5.921,13.125-5.921,20.718c0,7.125,1.89,13.781,5.203,19.531   c-15.218,15.843-32.812,39.748-49.091,67.974c-32.53,56.312-47.623,108.465-33.749,116.465   c13.875,8.03,51.466-31.124,83.996-87.435c16.499-28.594,28.499-56.1,34.529-77.317c13.578-0.563,25.358-8,31.967-18.905   c21.375,5.375,51.169,8.718,84.151,8.718c65.028,0,117.744-13,117.744-29.03C434.771,190.958,382.056,177.958,317.027,177.958z"/><path d="M218.048,265.643c-7.328,21.068-18.608,45.1-32.452,69.1c-7.187,12.438-14.812,24.404-22.546,35.404l-4.75,141.839h78.512   l-8.406-250.749C225.11,263.018,221.642,264.518,218.048,265.643z"/></g></svg>
            <h1>OpenAFPM CAD Visualization</h1>
        </header>
        <main>
            <form action="visualize" method="POST">
                <label>
                    Wind Turbine
                    <select name="Variant">
                        <option value="T Shape">T Shape</option>
                        <option value="H Shape">H Shape</option>
                        <option value="Star Shape">Star Shape</option>
                    </select>
                </label>
                <fieldset>
                    <legend>MagnAFPM</legend>
                    <section>
                        <label>
                            Rotor Disk Radius
                            <input type="text" name="RotorDiskRadius">
                        </label>
                        <label>
                            Disk Thickness
                            <input type="text" name="DiskThickness">
                        </label>
                    </section>
                    <section>
                        <label>
                            Magnet Length
                            <input type="text" name="MagnetLength">
                        </label>
                        <label>
                            Magnet Width
                            <input type="text" name="MagnetWidth">
                        </label>
                        <label>
                            Magnet Thickness
                            <input type="text" name="MagnetThickness">
                        </label>
                    </section>
                    <section>
                        <label>
                            Number Magnet
                            <input type="text" name="NumberMagnet">
                        </label>
                    </section>
                    <section>
                        <label>
                            Stator Thickness
                            <input type="text" name="StatorThickness">
                        </label>
                        <label>
                            Mechanical Clearance
                            <input type="text" name="MechanicalClearance">
                        </label>
                    </section>
                    <section>
                        <label>
                            Coil Leg Width
                            <input type="text" name="CoilLegWidth">
                        </label>
                        <label>
                            Coil Inner Width 1
                            <input type="text" name="CoilInnerWidth1">
                        </label>
                        <label>
                            Coil Inner Width 2
                            <input type="text" name="CoilInnerWidth2">
                        </label>
                    </section>
                </fieldset>
                <fieldset>
                    <legend>Furling</legend>
                    <section>
                        <label>
                            Angle
                            <input type="text" name="Angle">
                        </label>
                        <label>
                            Offset
                            <input type="text" name="Offset">
                        </label>
                    </section>
                    <section>
                        <label>
                            Bracket Length
                            <input type="text" name="BracketLength">
                        </label>
                        <label>
                            Bracket Width
                            <input type="text" name="BracketWidth">
                        </label>
                        <label>
                            Bracket Thickness
                            <input type="text" name="BracketThickness">
                        </label>
                    </section>
                    <section>
                        <label>
                            Boom Length
                            <input type="text" name="BoomLength">
                        </label>
                        <label>
                            Boom Pipe Radius
                            <input type="text" name="BoomPipeRadius">
                        </label>
                        <label>
                            Boom Pipe Thickness
                            <input type="text" name="BoomPipeThickness">
                        </label>
                    </section>
                    <section>
                        <label>
                            Vane Length
                            <input type="text" name="VaneLength">
                        </label>
                        <label>
                            Vane Thickness
                            <input type="text" name="VaneThickness">
                        </label>
                        <label>
                            Vane Width
                            <input type="text" name="VaneWidth">
                        </label>
                    </section>
                </fieldset>
                <fieldset>
                    <legend>User</legend>
                    <section>
                        <label>
                            Hub Holes Placement
                            <input type="text" name="HubHolesPlacement">
                        </label>
                        <label>
                            Hub Holes
                            <input type="text" name="HubHoles">
                        </label>
                        <label>
                            Holes
                            <input type="text" name="Holes">
                        </label>
                    </section>
                    <section>
                        <label>
                            Metal Length L
                            <input type="text" name="MetalLengthL">
                        </label>
                        <label>
                            Metal Thickness L
                            <input type="text" name="MetalThicknessL">
                        </label>
                        <label>
                            Flat Metal Thickness
                            <input type="text" name="FlatMetalThickness">
                        </label>    
                    </section>
                    <section>
                        <label>
                            Yaw Pipe Radius
                            <input type="text" name="YawPipeRadius">
                        </label>
                        <label>
                            Pipe Thickness
                            <input type="text" name="PipeThickness">
                        </label>
                    </section>
                    <section>
                        <label>
                            Rotor Inner Circle
                            <input type="text" name="RotorInnerCircle">
                        </label>
                        <label>
                            Resine Rotor Margin
                            <input type="text" name="ResineRotorMargin">
                        </label>
                    </section>
                </fieldset>
                <div id="error-banner" style="display: none; opacity: 0;">
                    <div style="display: flex; align-items: center">
                        <svg class="error-icon" fill="#ffffff" width="24" height="24" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>
                        <p id="error-message"></p>
                    </div>
                    <button style="border: none; background: transparent; cursor: pointer;" id="dismissErrorButton">
                        <svg fill="#ffffff" width="24" height="24" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                    </button>
                </div>
                <button type="submit" class="primary-button">
                    Visualize
                </button>
            </form>
        </main>
    </div>
    <div id="visualization" class="tabcontent" style="display: none; opacity: 0;">
        <div id="visualization-root">
            <div class="empty-state">
                <svg alt="Wind Turbine" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="65" height="65" fill="#9E9E9E" version="1.1" x="0px" y="0px" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><g><path d="M317.027,177.958c-32.982,0-62.777,3.344-84.151,8.718c-6.516-10.781-18.077-18.155-31.405-18.905   c-5.828-21.437-18.077-49.779-35.092-79.247c-32.53-56.31-70.122-95.496-83.996-87.466c-13.874,8,1.219,60.154,33.749,116.465   c16.546,28.687,34.42,52.904,49.81,68.716c-3.75,6.031-5.921,13.125-5.921,20.718c0,7.125,1.89,13.781,5.203,19.531   c-15.218,15.843-32.812,39.748-49.091,67.974c-32.53,56.312-47.623,108.465-33.749,116.465   c13.875,8.03,51.466-31.124,83.996-87.435c16.499-28.594,28.499-56.1,34.529-77.317c13.578-0.563,25.358-8,31.967-18.905   c21.375,5.375,51.169,8.718,84.151,8.718c65.028,0,117.744-13,117.744-29.03C434.771,190.958,382.056,177.958,317.027,177.958z"/><path d="M218.048,265.643c-7.328,21.068-18.608,45.1-32.452,69.1c-7.187,12.438-14.812,24.404-22.546,35.404l-4.75,141.839h78.512   l-8.406-250.749C225.11,263.018,221.642,264.518,218.048,265.643z"/></g></svg>
                <p style="font-size: 1.728rem; font-weight: bold;">No Visualization</p>
                <p style="font-size: 1rem;">Click <strong>Visualize</strong> button on <strong>Inputs</strong> tab.</p>
            </div>
        </div>
        <form method="GET" action="WindTurbine.zip">
            <button id="download-button" class="primary-button" disabled="true" type="submit" title="Download">
                <svg class="download-icon" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
            </button>
        </form>
    </div>
    <script src="openafpm-cad-visualization.js"></script>
    <script>
        function loadObj(objUrl) {
            const tabs = document.getElementsByTagName('nav')[0];
            const tabsHeight = tabs.offsetHeight;
            const windTurbineVisualization = new OpenAfpmCadVisualization({
                objUrl,
                rootDomElement: window.document.getElementById('visualization-root'),
                width: window.innerWidth,
                height: window.innerHeight - tabsHeight
            });
            window.addEventListener('resize', () => {
                windTurbineVisualization.resize(window.innerWidth, window.innerHeight - tabsHeight)
            }, false);
            window.addEventListener('mousemove', (e) => {
                windTurbineVisualization.handleMouseMove(e)
            }, false);
        }

        const WindTurbine = {
            T_SHAPE: 'T Shape',
            H_SHAPE: 'H Shape',
            STAR_SHAPE: 'Star Shape'
        }
        const parametersByVariant = {
            [WindTurbine.T_SHAPE]: {
                'magnafpm': {
                    'RotorDiskRadius': 150,
                    'DiskThickness': 10,
                    'MagnetLength': 46,
                    'MagnetWidth': 30,
                    'MagnetThickness': 10,
                    'NumberMagnet': 12,
                    'StatorThickness': 13,
                    'CoilLegWidth': 22.5,
                    'CoilInnerWidth1': 30,
                    'CoilInnerWidth2': 30,
                    'MechanicalClearance': 3
                },
                'furling': {
                    'Angle': 20,
                    'BracketLength': 300,
                    'BracketWidth': 30,
                    'BracketThickness': 5,
                    'BoomLength': 1000,
                    'BoomPipeRadius': 24.15,
                    'BoomPipeThickness': 5,
                    'VaneThickness': 6,
                    'VaneLength': 1200,
                    'VaneWidth': 500,
                    'Offset': 125
                },
                'user': {
                    'HubHolesPlacement': 50,
                    'RotorInnerCircle': 32.5,
                    'Holes': 6,
                    'MetalLengthL': 50,
                    'MetalThicknessL': 6,
                    'FlatMetalThickness': 10,
                    'YawPipeRadius': 30.15,
                    'PipeThickness': 5,
                    'ResineRotorMargin': 5,
                    'HubHoles': 6
                }
            },
            [WindTurbine.H_SHAPE]: {
                'magnafpm': {
                    'RotorDiskRadius': 230,
                    'DiskThickness': 10,
                    'MagnetLength': 46,
                    'MagnetWidth': 30,
                    'MagnetThickness': 10,
                    'NumberMagnet': 16,
                    'StatorThickness': 13,
                    'CoilLegWidth': 22.5,
                    'CoilInnerWidth1': 30,
                    'CoilInnerWidth2': 30,
                    'MechanicalClearance': 3
                },
                'furling': {
                    'Angle': 20,
                    'BracketLength': 300,
                    'BracketWidth': 30,
                    'BracketThickness': 5,
                    'BoomLength': 1000,
                    'BoomPipeRadius': 24.15,
                    'BoomPipeThickness': 5,
                    'VaneThickness': 6,
                    'VaneLength': 1200,
                    'VaneWidth': 500,
                    'Offset': 250
                },
                'user': {
                    'HubHolesPlacement': 65,
                    'RotorInnerCircle': 47.5,
                    'Holes': 6,
                    'MetalLengthL': 50,
                    'MetalThicknessL': 6,
                    'FlatMetalThickness': 10,
                    'YawPipeRadius': 44.5,
                    'PipeThickness': 5,
                    'ResineRotorMargin': 5,
                    'HubHoles': 7
                }
            },
            [WindTurbine.STAR_SHAPE]: {
                'magnafpm': {
                    'RotorDiskRadius': 349,
                    'DiskThickness': 10,
                    'MagnetLength': 58,
                    'MagnetWidth': 30,
                    'MagnetThickness': 10,
                    'NumberMagnet': 32,
                    'StatorThickness': 15,
                    'CoilLegWidth': 22.5,
                    'CoilInnerWidth1': 30,
                    'CoilInnerWidth2': 30,
                    'MechanicalClearance': 3
                },
                'furling': {
                    'Angle': 20,
                    'BracketLength': 300,
                    'BracketWidth': 30,
                    'BracketThickness': 5,
                    'BoomLength': 1000,
                    'BoomPipeRadius': 24.15,
                    'BoomPipeThickness': 5,
                    'VaneThickness': 6,
                    'VaneLength': 1200,
                    'VaneWidth': 500,
                    'Offset': 250
                },
                'user': {
                    'HubHolesPlacement': 102.5,
                    'RotorInnerCircle': 81.5,
                    'Holes': 7,
                    'MetalLengthL': 65,
                    'MetalThicknessL': 8,
                    'FlatMetalThickness': 10,
                    'YawPipeRadius': 57.15,
                    'PipeThickness': 5,
                    'ResineRotorMargin': 5,
                    'HubHoles': 8
                }
            }
        };
        const form = window.document.forms[0];
        const defaultVariant = WindTurbine.T_SHAPE;
        const state = {
            selectedVariant: defaultVariant,
            objUrl: '',
            form: '',
            prevForm: ''
        };
        const handleScroll = debounce(event => {
            if (document.scrollingElement.scrollTop === 0) {
                if (state.form) {
                    document.getElementsByTagName('nav')[0].children[1].click();
                    window.removeEventListener('scroll', handleScroll);
                    document.getElementById('download-button').disabled = false;
                }
            }
        }, 100);
        function handleSubmit(event) {
            window.addEventListener('scroll', handleScroll);
            event.preventDefault();
            const submitterTextContent = event.submitter.textContent;
            event.submitter.textContent = 'Loading...';
            event.submitter.disabled = true;
            const body = new URLSearchParams(new FormData(event.target));
            fetch(event.target.action, {
                body,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                method: event.target.method
            })
            .then(r => r.json())
            .then(r => {
                if (r.error) {
                    throw new Error(r.error);
                }
                return r;
            })
            .then(response => {
                const {objUrl} = response;
                state.objUrl = objUrl
                document.body.scrollTop = document.documentElement.scrollTop = 0;
                state.form = body.toString();
            }).catch(error => {
                const errorBanner = document.getElementById('error-banner');
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = error.message;
                console.error(error.message);
                errorBanner.style.display = 'flex';
                setTimeout(() => {
                    errorBanner.style.opacity = '1';
                }, 20);
            }).finally(() => {
                event.submitter.textContent = submitterTextContent;
                event.submitter.disabled = false;
            });
        }

        const dismissErrorButton = document.getElementById('dismissErrorButton');
        dismissErrorButton.addEventListener('click', event => {
            event.stopPropagation();
            event.preventDefault();
            const errorBanner = document.getElementById('error-banner');
            errorBanner.style.opacity = '0';
            setTimeout(() => {
                errorBanner.style.display = "none";
            }, 250);
        });
        form.addEventListener('submit', handleSubmit);
        populateForm(form, state.selectedVariant);
        function populateForm(form, selectedVariant) {
            const parameters = parametersByVariant[selectedVariant];
            const keyValuePairs = Object.entries(flatten(parameters));
            for (const [key, value] of keyValuePairs) {
                form[key].value = value;
            }
        }
        const select = document.getElementsByTagName('select')[0];
        function handleSelect(event) {
            state.selectedVariant = event.target.value;
            populateForm(form, state.selectedVariant);
        }
        select.addEventListener('change', handleSelect);
        function flatten(object) {
            return Object.values(object).reduce((acc, obj) => ({...acc, ...obj}), {});
        }

        function debounce(fn, ms) {
            let id;
            return (...args) => {
                if (id) {
                    clearTimeout(id);
                }
                id = setTimeout(() => {
                    fn(...args);
                }, ms);
            };
        }

        function selectTab(event) {
            const selectedTab = event.target;
            const parent = selectedTab.parentElement;
            const selectedTabIndex = Array.prototype.findIndex.call(parent.children, tab => tab === selectedTab);
            const activeTabIndex = Array.prototype.findIndex.call(parent.children, tab => tab.classList.contains('active'));
            const activeTab = parent.children[activeTabIndex];
            activeTab.classList.remove('active');
            selectedTab.classList.add('active');

            const containers = document.getElementsByClassName('tabcontent');
            containers[activeTabIndex].style.display = 'none';
            containers[selectedTabIndex].style.display = 'block';

            setTimeout(() => {
                containers[activeTabIndex].style.opacity = '0';
                containers[selectedTabIndex].style.opacity = '1';
            }, 20);

            const form = document.getElementsByTagName('form')[0];
            const body = new URLSearchParams(new FormData(form));

            if(state.objUrl && selectedTabIndex == 1) {
                const visualization = document.getElementById('visualization-root');
                const load = () => {
                    loadObj(state.objUrl);
                    state.prevForm = state.form;
                };
                if(visualization.children.length === 0) {
                    load();
                }
                if (visualization.children.length !== 0 && state.prevForm !== state.form) {
                    visualization.innerHTML = '';
                    load();
                }
            }
        }
    </script>
</body>
</html>
